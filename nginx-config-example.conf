# NGINX Configuration for TableMaster API
# This should be placed in /etc/nginx/sites-available/tablemaster-api on your VPS

server {
    listen 80;
    server_name your-domain.com;  # Change to your actual domain

    # Increase client body size for file uploads
    client_max_body_size 15M;  # Allow files up to 15MB (API has 10MB limit)

    # Timeouts for long uploads
    client_body_timeout 120s;
    client_header_timeout 120s;

    # Proxy timeouts
    proxy_connect_timeout 120s;
    proxy_send_timeout 120s;
    proxy_read_timeout 120s;

    location / {
        # Proxy to Node.js API
        proxy_pass http://localhost:4000;

        # Preserve original request info
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # IMPORTANT: Don't buffer for SSE connections
        proxy_buffering off;
        proxy_cache off;

        # SSE specific headers
        proxy_http_version 1.1;
        proxy_set_header Connection '';

        # Disable buffering for multipart uploads
        proxy_request_buffering off;
    }

    # SSE specific location (optional, for better control)
    location /api/notifications/stream {
        proxy_pass http://localhost:4000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection '';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # SSE requires no buffering
        proxy_buffering off;
        proxy_cache off;

        # Long timeout for SSE
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }

    # Return JSON error instead of HTML
    error_page 413 = @error413;
    location @error413 {
        default_type application/json;
        return 413 '{"error": {"message": "File too large. Maximum size is 15MB"}}';
    }
}

# SSL Configuration (after certbot)
# server {
#     listen 443 ssl http2;
#     server_name your-domain.com;
#
#     ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
#
#     # ... rest of config same as above ...
# }
